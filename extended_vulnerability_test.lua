--[[
    Extended Vulnerability Tests - Additional test modules
    
    This file contains additional specialized vulnerability tests that can be
    loaded alongside the main checker for even more comprehensive testing.
]]

local ExtendedTests = {}

-- 14. File System and Registry Access Tests
function ExtendedTests:testFileSystemAccess()
    print("\n📂 File System Access - Can read/write files outside sandbox")
    
    local fileFunctions = {
        {"readfile", "HIGH"},
        {"writefile", "CRITICAL"},
        {"appendfile", "HIGH"},
        {"makefolder", "MEDIUM"},
        {"delfolder", "HIGH"},
        {"delfile", "HIGH"},
        {"isfile", "LOW"},
        {"isfolder", "LOW"},
        {"listfiles", "MEDIUM"},
        {"loadfile", "HIGH"},
        {"dofile", "HIGH"},
        {"getcustomasset", "MEDIUM"},
        {"getsynasset", "MEDIUM"},
        {"saveinstance", "HIGH"}
    }
    
    for _, funcData in ipairs(fileFunctions) do
        local funcName, severity = funcData[1], funcData[2]
        local func = getgenv()[funcName] or _G[funcName]
        
        if func then
            -- Test actual malicious file operations
            local success, result = safeCall(function()
                if funcName == "readfile" then
                    -- Actually attempt to read sensitive system files
                    local sensitiveFiles = {
                        "C:\\Windows\\System32\\drivers\\etc\\hosts",
                        "C:\\Windows\\win.ini",
                        "../../../Windows/System32/drivers/etc/hosts"
                    }
                    for _, path in ipairs(sensitiveFiles) do
                        local content = func(path)
                        if content and #content > 10 then -- Actual file content
                            return {path = path, content = string.sub(content, 1, 100)}
                        end
                    end
                elseif funcName == "writefile" then
                    -- Test actual file creation in restricted areas
                    local testContent = "VULNERABILITY_TEST_" .. tick()
                    local restrictedPaths = {
                        "C:\\Windows\\Temp\\vuln_test.txt",
                        "C:\\Users\\Public\\vuln_test.txt",
                        "../vuln_test.txt"
                    }
                    for _, path in ipairs(restrictedPaths) do
                        func(path, testContent)
                        -- Verify file was actually created
                        if isfile and isfile(path) then
                            -- Clean up
                            if delfile then delfile(path) end
                            return {path = path, success = true}
                        end
                    end
                elseif funcName == "listfiles" then
                    -- Test actual directory enumeration
                    local sensitiveDirectories = {"C:\\Windows\\System32", "C:\\Users"}
                    for _, dir in ipairs(sensitiveDirectories) do
                        local files = func(dir)
                        if files and type(files) == "table" and #files > 0 then
                            return {directory = dir, fileCount = #files, sample = files[1]}
                        end
                    end
                elseif funcName == "saveinstance" then
                    -- Test game data exfiltration
                    local success = func(workspace, "stolen_game_data.rbxl")
                    if success and isfile and isfile("stolen_game_data.rbxl") then
                        if delfile then delfile("stolen_game_data.rbxl") end
                        return {dataExfiltration = true}
                    end
                else
                    return func()
                end
            end)
            
            if success and result then
                if type(result) == "table" then
                    if result.content then
                        printResult(severity, funcName, "FAIL", "CRITICAL: Read sensitive file " .. result.path .. " - Content: " .. result.content)
                    elseif result.success then
                        printResult(severity, funcName, "FAIL", "CRITICAL: Successfully wrote to restricted path " .. result.path)
                    elseif result.fileCount then
                        printResult(severity, funcName, "FAIL", "CRITICAL: Enumerated " .. result.fileCount .. " files in " .. result.directory)
                    elseif result.dataExfiltration then
                        printResult(severity, funcName, "FAIL", "CRITICAL: Can exfiltrate entire game data")
                    end
                else
                    printResult(severity, funcName, "FAIL", "File system access available")
                end
            else
                printResult(severity, funcName, "PASS", "File access blocked or restricted")
            end
        else
            printResult(severity, funcName, "PASS", "Function not available")
        end
    end
end

-- 15. Process and System Information Tests
function ExtendedTests:testProcessAccess()
    print("\n⚙️ Process and System Access - Can interact with system processes")
    
    -- Test actual process manipulation capabilities
    local processTests = {
        {"Process Enumeration", "HIGH", function()
            if getprocesses then
                local processes = getprocesses()
                if processes and type(processes) == "table" and #processes > 0 then
                    -- Look for sensitive processes
                    local sensitiveProcesses = {}
                    for _, proc in ipairs(processes) do
                        local name = tostring(proc.Name or proc.ProcessName or proc):lower()
                        if string.find(name, "roblox") or string.find(name, "discord") or 
                           string.find(name, "chrome") or string.find(name, "firefox") then
                            table.insert(sensitiveProcesses, name)
                        end
                    end
                    return {total = #processes, sensitive = sensitiveProcesses}
                end
            end
            return false
        end},
        
        {"Process Termination", "CRITICAL", function()
            if killprocess and getprocesses then
                -- Find a safe test process (notepad if available)
                local processes = getprocesses()
                if processes then
                    for _, proc in ipairs(processes) do
                        local name = tostring(proc.Name or proc.ProcessName or proc):lower()
                        if string.find(name, "notepad") then
                            local success = killprocess(proc.Id or proc.PID or proc)
                            return success
                        end
                    end
                end
            end
            return false
        end},
        
        {"System Information Extraction", "MEDIUM", function()
            local sysInfo = {}
            if gethwid then sysInfo.hwid = gethwid() end
            if getcpuid then sysInfo.cpu = getcpuid() end
            if getraminfo then sysInfo.ram = getraminfo() end
            
            return next(sysInfo) and sysInfo or false
        end}
    }
    
    for _, test in ipairs(processTests) do
        local name, severity, testFunc = test[1], test[2], test[3]
        local result = testFunc()
        
        if result then
            if type(result) == "table" then
                if result.total then
                    printResult(severity, name, "FAIL", "CRITICAL: Enumerated " .. result.total .. " processes, including: " .. table.concat(result.sensitive, ", "))
                elseif result.hwid then
                    printResult(severity, name, "FAIL", "CRITICAL: Extracted system info - HWID: " .. tostring(result.hwid))
                end
            else
                printResult(severity, name, "FAIL", "CRITICAL: Process manipulation successful")
            end
        else
            printResult(severity, name, "PASS", "Process access blocked")
        end
    end
end

-- 16. DLL Injection and Code Injection Tests
function ExtendedTests:testCodeInjection()
    print("\n💉 Code Injection - DLL injection and code manipulation")
    
    local injectionFunctions = {
        {"loadlibrary", "CRITICAL"},
        {"freelibrary", "HIGH"},
        {"getprocaddress", "HIGH"},
        {"virtualalloc", "CRITICAL"},
        {"virtualfree", "HIGH"},
        {"virtualprotect", "CRITICAL"},
        {"createthread", "CRITICAL"},
        {"resumethread", "HIGH"},
        {"suspendthread", "HIGH"},
        {"ntdll", "CRITICAL"},
        {"kernel32", "CRITICAL"},
        {"user32", "HIGH"},
        {"advapi32", "HIGH"},
        {"shell32", "HIGH"},
        {"wininet", "HIGH"},
        {"ws2_32", "MEDIUM"},
        {"psapi", "MEDIUM"},
        {"dbghelp", "HIGH"}
    }
    
    for _, funcData in ipairs(injectionFunctions) do
        local funcName, severity = funcData[1], funcData[2]
        local func = getgenv()[funcName] or _G[funcName]
        
        if func then
            printResult(severity, funcName, "FAIL", "Code injection capability available")
        else
            printResult(severity, funcName, "PASS", "Function not available")
        end
    end
end

-- 17. Registry Access Tests
function ExtendedTests:testRegistryAccess()
    print("\n📋 Registry Access - Can modify Windows registry")
    
    local registryFunctions = {
        {"reg_read", "HIGH"},
        {"reg_write", "CRITICAL"},
        {"reg_delete", "CRITICAL"},
        {"reg_create", "HIGH"},
        {"reg_enum", "MEDIUM"}
    }
    
    for _, funcData in ipairs(registryFunctions) do
        local funcName, severity = funcData[1], funcData[2]
        local func = getgenv()[funcName] or _G[funcName]
        
        if func then
            local success, error = safeCall(function()
                if funcName == "reg_read" then
                    return func("HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion", "ProgramFilesDir")
                else
                    return func()
                end
            end)
            
            if success or (error and not string.find(error, "missing or nil")) then
                printResult(severity, funcName, "FAIL", "Registry access available")
            else
                printResult(severity, funcName, "PASS", "Registry access blocked")
            end
        else
            printResult(severity, funcName, "PASS", "Function not available")
        end
    end
end

-- 18. Clipboard and Input Manipulation Tests
function ExtendedTests:testInputManipulation()
    print("\n⌨️ Input Manipulation - Can control user input and clipboard")
    
    -- Test clipboard access
    local clipboardFunctions = {
        {"getclipboard", "MEDIUM"},
        {"setclipboard", "HIGH"}
    }
    
    for _, funcData in ipairs(clipboardFunctions) do
        local funcName, severity = funcData[1], funcData[2]
        local func = getgenv()[funcName] or _G[funcName]
        
        if func then
            local success, result = safeCall(func)
            if funcName == "getclipboard" and success then
                printResult(severity, funcName, "FAIL", "Can read clipboard")
            elseif funcName == "setclipboard" then
                printResult(severity, funcName, "FAIL", "Can modify clipboard")
            else
                printResult(severity, funcName, "PASS", "Clipboard access blocked")
            end
        else
            printResult(severity, funcName, "PASS", "Function not available")
        end
    end
    
    -- Test virtual input
    local inputFunctions = {
        {"keypress", "HIGH"},
        {"keyrelease", "HIGH"},
        {"mouse1press", "MEDIUM"},
        {"mouse1release", "MEDIUM"},
        {"mouse2press", "MEDIUM"},
        {"mouse2release", "MEDIUM"},
        {"mousemoveabs", "MEDIUM"},
        {"mousemoverel", "MEDIUM"}
    }
    
    for _, funcData in ipairs(inputFunctions) do
        local funcName, severity = funcData[1], funcData[2]
        local func = getgenv()[funcName] or _G[funcName]
        
        if func then
            printResult(severity, funcName, "FAIL", "Virtual input available")
        else
            printResult(severity, funcName, "PASS", "Function not available")
        end
    end
end

-- 19. Cryptographic and Encoding Tests
function ExtendedTests:testCryptographicFunctions()
    print("\n🔐 Cryptographic Functions - Encryption/decryption capabilities")
    
    local cryptoFunctions = {
        {"crypt.encrypt", "MEDIUM"},
        {"crypt.decrypt", "MEDIUM"},
        {"crypt.hash", "LOW"},
        {"crypt.base64encode", "LOW"},
        {"crypt.base64decode", "LOW"},
        {"crypt.generatekey", "MEDIUM"}
    }
    
    for _, funcData in ipairs(cryptoFunctions) do
        local funcName, severity = funcData[1], funcData[2]
        local func
        
        if string.find(funcName, "crypt%.") then
            local cryptFunc = string.gsub(funcName, "crypt%.", "")
            func = crypt and crypt[cryptFunc]
        end
        
        if func then
            printResult(severity, funcName, "FAIL", "Cryptographic function available")
        else
            printResult(severity, funcName, "PASS", "Function not available")
        end
    end
end

-- 20. Advanced Metamethod and Hook Tests
function ExtendedTests:testAdvancedHooks()
    print("\n🪝 Advanced Hooks - Metamethod and function hooking")
    
    local hookFunctions = {
        {"hookfunction", "HIGH"},
        {"hookmetamethod", "HIGH"},
        {"getnamecallmethod", "MEDIUM"},
        {"setnamecallmethod", "HIGH"},
        {"getgc", "MEDIUM"},
        {"getgenv", "MEDIUM"},
        {"getrenv", "HIGH"},
        {"getsenv", "HIGH"}
    }
    
    for _, funcData in ipairs(hookFunctions) do
        local funcName, severity = funcData[1], funcData[2]
        local func = getgenv()[funcName] or _G[funcName]
        
        if func then
            -- Test if we can hook critical functions
            if funcName == "hookfunction" then
                local success, error = safeCall(function()
                    local old = func(print, function() end)
                    func(print, old) -- Restore
                    return true
                end)
                
                if success then
                    printResult(severity, funcName, "FAIL", "Can hook functions")
                else
                    printResult(severity, funcName, "PASS", "Function hooking blocked")
                end
            else
                printResult(severity, funcName, "FAIL", "Hook function available")
            end
        else
            printResult(severity, funcName, "PASS", "Function not available")
        end
    end
end

-- 21. Console and Debug Access Tests
function ExtendedTests:testConsoleAccess()
    print("\n🖥️ Console Access - Can access debug console")
    
    local consoleFunctions = {
        {"rconsolecreate", "MEDIUM"},
        {"rconsoledestroy", "LOW"},
        {"rconsoleclear", "LOW"},
        {"rconsoleinput", "MEDIUM"},
        {"rconsoleprint", "LOW"},
        {"rconsolename", "LOW"}
    }
    
    for _, funcData in ipairs(consoleFunctions) do
        local funcName, severity = funcData[1], funcData[2]
        local func = getgenv()[funcName] or _G[funcName]
        
        if func then
            if funcName == "rconsolecreate" then
                local success, error = safeCall(func)
                if success then
                    printResult(severity, funcName, "FAIL", "Can create debug console")
                    -- Clean up
                    safeCall(function()
                        if rconsoledestroy then rconsoledestroy() end
                    end)
                else
                    printResult(severity, funcName, "PASS", "Console creation blocked")
                end
            else
                printResult(severity, funcName, "FAIL", "Console function available")
            end
        else
            printResult(severity, funcName, "PASS", "Function not available")
        end
    end
end

-- 22. WebSocket and Real-time Communication Tests
function ExtendedTests:testWebSocketCommunication()
    print("\n🔌 WebSocket Communication - Real-time external communication")
    
    local wsSuccess, wsError = safeCall(function()
        if WebSocket then
            local ws = WebSocket.connect("wss://echo.websocket.org")
            if ws then
                ws:Close()
                return true
            end
        end
        return false
    end)
    
    if wsSuccess and wsError then
        printResult("HIGH", "WebSocket Connection", "FAIL", "Can establish WebSocket connections")
    else
        printResult("HIGH", "WebSocket Connection", "PASS", "WebSocket blocked or unavailable")
    end
    
    -- Test custom WebSocket implementations
    local customWsFunctions = {
        {"websocket_connect", "HIGH"},
        {"ws_connect", "HIGH"},
        {"socket_connect", "HIGH"}
    }
    
    for _, funcData in ipairs(customWsFunctions) do
        local funcName, severity = funcData[1], funcData[2]
        local func = getgenv()[funcName] or _G[funcName]
        
        if func then
            printResult(severity, funcName, "FAIL", "Custom WebSocket function available")
        else
            printResult(severity, funcName, "PASS", "Function not available")
        end
    end
end

-- 23. Anti-Detection and Stealth Tests
function ExtendedTests:testAntiDetection()
    print("\n👻 Anti-Detection - Stealth and evasion capabilities")
    
    local stealthFunctions = {
        {"hide_process", "HIGH"},
        {"spoof_hwid", "HIGH"},
        {"change_identity", "MEDIUM"},
        {"bypass_detection", "HIGH"}
    }
    
    for _, funcData in ipairs(stealthFunctions) do
        local funcName, severity = funcData[1], funcData[2]
        local func = getgenv()[funcName] or _G[funcName]
        
        if func then
            printResult(severity, funcName, "FAIL", "Anti-detection capability available")
        else
            printResult(severity, funcName, "PASS", "Function not available")
        end
    end
    
    -- Test thread identity manipulation
    if setthreadidentity and getthreadidentity then
        local originalIdentity = getthreadidentity()
        local success, error = safeCall(function()
            setthreadidentity(7) -- CoreScript identity
            local newIdentity = getthreadidentity()
            setthreadidentity(originalIdentity) -- Restore
            return newIdentity == 7
        end)
        
        if success and error then
            printResult("HIGH", "Thread Identity Manipulation", "FAIL", "Can change thread identity to CoreScript level")
        else
            printResult("HIGH", "Thread Identity Manipulation", "PASS", "Thread identity changes blocked")
        end
    else
        printResult("HIGH", "Thread Identity Manipulation", "PASS", "Functions not available")
    end
end

-- 24. Hardware Information Access Tests
function ExtendedTests:testHardwareAccess()
    print("\n🖥️ Hardware Information - Can access system hardware info")
    
    local hwFunctions = {
        {"gethwid", "MEDIUM"},
        {"getcpuid", "MEDIUM"},
        {"getgpuinfo", "LOW"},
        {"getraminfo", "LOW"},
        {"getdiskinfo", "LOW"}
    }
    
    for _, funcData in ipairs(hwFunctions) do
        local funcName, severity = funcData[1], funcData[2]
        local func = getgenv()[funcName] or _G[funcName]
        
        if func then
            local success, result = safeCall(func)
            if success and result then
                printResult(severity, funcName, "FAIL", "Hardware info accessible")
            else
                printResult(severity, funcName, "PASS", "Hardware access blocked")
            end
        else
            printResult(severity, funcName, "PASS", "Function not available")
        end
    end
end

-- 25. Script Decompilation and Analysis Tests
function ExtendedTests:testScriptAnalysis()
    print("\n🔍 Script Analysis - Can decompile and analyze scripts")
    
    local analysisFunctions = {
        {"decompile", "MEDIUM"},
        {"getscript", "MEDIUM"},
        {"getscripts", "MEDIUM"},
        {"getsource", "MEDIUM"},
        {"getbytecode", "HIGH"}
    }
    
    for _, funcData in ipairs(analysisFunctions) do
        local funcName, severity = funcData[1], funcData[2]
        local func = getgenv()[funcName] or _G[funcName]
        
        if func then
            printResult(severity, funcName, "FAIL", "Script analysis capability available")
        else
            printResult(severity, funcName, "PASS", "Function not available")
        end
    end
end

return ExtendedTests
